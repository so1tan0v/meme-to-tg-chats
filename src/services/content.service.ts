import * as cheerio from 'cheerio';import download from 'download';import youtubeDl from 'youtube-dl-exec';import { BrowserService } from './browser.service';import { v4 } from 'uuid';import { Quality } from './content.interface';import puppeteer from 'puppeteer';import * as fs from 'node:fs';interface IGetVideoResult {    success: boolean;    file: Buffer | null;    message: string | null;    options: Quality[];}export class ContentService {    static isUrl(url: string): boolean {        return !!(url && url.indexOf('http') === 0 && url.split(' ').length === 1);    }    static async getFileFromInstagram(url: string) {        const result: IGetVideoResult = {            success: true,            file: null,            message: null,            options: [],        };        let siteContent;        try {            siteContent = await BrowserService.fetchPageContent(url);        } catch (e) {            result.success = false;            result.message = 'При открытии ссылки с видео:\n ``` ' + JSON.stringify(e) + '```';            return result;        }        const $ = cheerio.load(siteContent, {});        const $video = $('video');        if (!$video.length) {            result.success = false;            result.message =                'При скачивании видео произошла ошибка:\n ``` Не удалось скачать видео ```';            return result;        }        const urlVideo = $video.attr('src');        if (urlVideo) {            result.file = await download(urlVideo);            return result;        } else {            result.success = false;            result.message =                'При скачивании видео произошла ошибка:\n ```Не удалось обнаружить ссылку на видео```';            return result;        }    }    static async getFileFromYouTube(url: string, offerDownloadVideoQuality: boolean = false) {        const result: IGetVideoResult = {            success: true,            file: null,            message: null,            options: [],        };        try {            const video = await youtubeDl(url, {                dumpSingleJson: true,                noCheckCertificates: true,                noWarnings: true,                addHeader: ['referer:youtube.com', 'user-agent:googlebot'],            });            const availableVideos = video.formats.filter(                (format) => format.url && format.acodec !== 'none' && format.vcodec !== 'none',            );            if (url.includes('shorts')) {                if (availableVideos[availableVideos.length - 1]) {                    result.file = await download(availableVideos[availableVideos.length - 1].url);                }            } else {                const uuid = v4();                const qualityData: Quality[] = availableVideos.map((item) => {                    const fileSize = item?.downloader_options?.http_chunk_size                        ? +item?.downloader_options?.http_chunk_size                        : item.filesize;                    return {                        ext: item.ext,                        url: item.url,                        code: `download_${uuid}-${item.format_note}`,                        format_note: item.format_note,                        filesize: fileSize,                        resolution: item.resolution,                    };                });                result.success = false;                result.message = null;                result.options = qualityData;                console.log(offerDownloadVideoQuality);            }        } catch (e) {            const errorMessage = JSON.stringify(e) ?? 'Не удалось получить ошибку';            result.success = false;            result.message =                'При скачивании видео с youtube произошел отвал: ``` ' + errorMessage + ' ```';        }        return result;    }    static async getFileFromTikTok(url: string): Promise<IGetVideoResult> {        const result: IGetVideoResult = {            success: true,            file: null,            message: null,            options: [],        };        let siteContent;        const browser = await puppeteer.launch({            executablePath: process.env.CHROME_PATH ?? '',            headless: true,            args: ['--no-sandbox', '--disable-dev-shm-usage'],        });        const page = await browser.newPage();        try {            await page.goto(url, { waitUntil: 'networkidle2' });            siteContent = await page.content();        } catch (e) {            result.success = false;            result.message = 'При открытии ссылки с видео:\n ``` ' + JSON.stringify(e) + '```';            await browser.close();            return result;        }        const $ = cheerio.load(siteContent, {});        const $video = $('video');        if (!$video.length) {            result.success = false;            result.message =                'При скачивании видео произошла ошибка:\n ``` Не удалось скачать видео ```';            await browser.close();            return result;        }        const urlVideo = $video.attr('src');        if (urlVideo) {            const response = await page.goto(urlVideo, { waitUntil: 'networkidle2' });            if (!(response && response.ok())) throw 'Ошибка скачивания видео';            const filePath = './video.mp4';            if (response) {                const buffer = await response.buffer();                fs.writeFileSync(filePath, buffer);            }            // result.file = file;        } else {            result.success = false;            result.message =                'При скачивании видео произошла ошибка:\n ```Не удалось обнаружить ссылку на видео```';            await browser.close();            return result;        }        return result;    }    static async getVideoFileByUrl(url: string, isLocalMessage: boolean = false) {        let result: IGetVideoResult = {            success: true,            file: null,            message: null,            options: [],        };        if (!ContentService.isUrl(url)) {            result.success = false;            result.message = 'Это не ссылка.';        }        if (url.indexOf('instagram') !== -1) {            result = await this.getFileFromInstagram(url);        } else if (url.indexOf('youtube') !== -1 || url.indexOf('youtu.be') !== -1) {            result = await this.getFileFromYouTube(url, isLocalMessage);        } else if (url.indexOf('vk.com') !== -1) {            result.success = false;            result.message = 'Фуу, вашу мать';        } else if (url.indexOf('tiktok') !== -1) {            result = await this.getFileFromTikTok(url);        }        return result;    }}